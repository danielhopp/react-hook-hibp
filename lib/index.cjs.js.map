{"version":3,"file":"index.cjs.js","sources":["../src/index.js"],"sourcesContent":["import { useState } from 'react'\nimport sha1 from 'sha1'\nimport { pwnedPasswordRange } from 'hibp'\n\n// https://haveibeenpwned.com/API/v2#SearchingPwnedPasswordsByRange\nconst hashPrefixLength = 5\n\n// https://haveibeenpwned.com/API/v2#RateLimiting\nexport const minRateLimit = 1500\n\nexport const defaultOptions = {\n  minLength: 8,\n  maxLength: 128\n}\n\nexport const statusCodes = [\n  'MIN_LENGTH',\n  'MAX_LENGTH',\n  'WAITING',\n  'CHECKING',\n  'PWNED',\n  'NOT_PWNED',\n  'CHECK_FAILED'\n].reduce((acc, code) => ({ ...acc, [code]: code }), {})\n\nlet rateLimit = minRateLimit\nlet cache = {}\nlet previousCheckTimestamp = null\nlet isChecking = false\nlet checkTimer = null\n\nexport const usePasswordCheck = (options = {}) => {\n  const [status, setStatus] = useState(null)\n\n  const opts = {\n    ...defaultOptions,\n    options\n  }\n\n  return [\n    status,\n    password => {\n\n      if (password.length < opts.minLength) {\n        setStatus(statusCodes.MIN_LENGTH)\n        return\n      }\n\n      if (password.length > opts.maxLength) {\n        setStatus(statusCodes.MAX_LENGTH)\n        return\n      }\n\n      const hash = sha1(password).toUpperCase()\n\n      // cache lookup\n      if (cache[hash]) {\n        setStatus(cache[hash])\n        return\n      }\n\n      // API request pending\n      if (checkTimer) {\n        setStatus(statusCodes.WAITING)\n        return\n      }\n\n      // prevent parallel API request\n      if (isChecking) {\n        setStatus(statusCodes.WAITING)\n        checkTimer = setTimeout(() => {\n          check({ hash, setStatus })\n          checkTimer = null\n        }, rateLimit)\n        return\n      }\n\n      // respect rate limit\n      const now = new Date().getTime()\n      const waitingTime = previousCheckTimestamp\n        ? rateLimit - (now - previousCheckTimestamp)\n        : 0\n\n      if (waitingTime > 0) {\n        setStatus(statusCodes.WAITING)\n        checkTimer = setTimeout(() => {\n          check({\n            hash,\n            setStatus: status =>\n              setStatus(checkTimer ? statusCodes.WAITING : status)\n          })\n          checkTimer = null\n        }, waitingTime)\n        return\n      }\n\n      check({ hash, setStatus })\n    }\n  ]\n}\n\nexport const setRateLimit = milliseconds => {\n  if (milliseconds < minRateLimit) {\n    throw new Error(`Minimum rate limit is ${minRateLimit} ms.`)\n  }\n  rateLimit = milliseconds\n}\n\n\nconst check = ({ hash, setStatus }) => {\n  setStatus(statusCodes.CHECKING)\n  isChecking = true\n  previousCheckTimestamp = new Date().getTime()\n\n  const prefix = hash.substr(0, hashPrefixLength)\n  const suffix = hash.substr(hashPrefixLength)\n\n  pwnedPasswordRange(prefix)\n    .then(results => {\n      const found = results.find(result => result.suffix === suffix)\n      const status = found ? statusCodes.PWNED : statusCodes.NOT_PWNED\n      cache[hash] = status\n      isChecking = false\n      setStatus(status)\n    })\n    .catch(e => {\n      isChecking = false\n      setStatus(statusCodes.CHECK_FAILED)\n    })\n}\n"],"names":["hashPrefixLength","minRateLimit","defaultOptions","minLength","maxLength","statusCodes","reduce","acc","code","rateLimit","cache","previousCheckTimestamp","isChecking","checkTimer","usePasswordCheck","options","useState","status","setStatus","opts","password","length","MIN_LENGTH","MAX_LENGTH","hash","sha1","toUpperCase","WAITING","setTimeout","check","now","Date","getTime","waitingTime","setRateLimit","milliseconds","Error","CHECKING","prefix","substr","suffix","pwnedPasswordRange","then","results","found","find","result","PWNED","NOT_PWNED","catch","CHECK_FAILED"],"mappings":"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"}